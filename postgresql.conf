# ---------------------
# Основные настройки
# ---------------------
max_connections = 500           # Максимальное число одновременных подключений
superuser_reserved_connections = 10  # Резерв для суперпользователей
unix_socket_directories = '/var/run/postgresql'  # Директория сокетов
listen_addresses = '*'          # Слушать все интерфейсы (для доступа извне контейнера)

# ---------------------
# Память
# ---------------------
huge_pages = try				# Использование больших страниц памяти (если поддерживается)
shared_buffers = 512MB            # Общая память для буферов (4-8% от RAM хоста, минимум 128MB)
work_mem = 2MB                  # Память на операцию сортировки/хеширования (на подключение)
maintenance_work_mem = 128MB    # Память для обслуживания (например, VACUUM)
effective_cache_size = 3GB      # Оценка доступной памяти для кеша (50-75% RAM)

# ---------------------
# Файловый ввод-вывод
# ---------------------
checkpoint_timeout = 10min      # Интервал между контрольными точками
min_wal_size = 1GB              # Минимальный размер WAL
max_wal_size = 4GB              # Максимальный размер WAL
wal_level = replica             # Уровень записи WAL (для репликации, если нужно)

# ---------------------
# Логирование
# ---------------------
log_destination = 'stderr'       # Логи в stderr (доступны через docker logs)
logging_collector = on          # Включение коллектора логов
#log_directory = '/var/log/postgresql'  # Директория для логов
log_filename = 'postgresql-%Y-%m-%d.log'  # Формат имени файла
log_min_messages = debug1       # Уровень логирования
log_min_duration_statement = 1000  # Логировать запросы, дольше 1 секунды (мс)
log_connections = on            # Логировать подключения
log_disconnections = on         # Логировать отключения

# ---------------------
# Производительность
# ---------------------
synchronous_commit = off        # Отключение синхронной фиксации для скорости (осторожно на продакшене)
wal_compression = on            # Сжатие WAL для экономии места
random_page_cost = 1.1          # Оптимизация для SSD (если используется)
effective_io_concurrency = 200  # Параллелизм ввода-вывода

# ---------------------
# Подключения и безопасность
# ---------------------
# (Оставьте пустым или настройте под ваши нужды, например, для SSL)
# ssl = on
# ssl_cert_file = '/etc/ssl/certs/ssl-cert-snakeoil.pem'
# ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'

# ---------------------
# Дополнительно
# ---------------------
# Настройки для высокой нагрузки (опционально)
max_parallel_workers_per_gather = 4  # Параллелизм запросов
max_parallel_workers = 8             # Общее число параллельных работников
